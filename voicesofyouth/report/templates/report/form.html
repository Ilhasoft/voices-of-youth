{% extends "voyadmin/base.html" %}

{% load static i18n sass_tags leaflet_tags %}

{% block extracss %}
    <link rel="stylesheet" href="{% static 'vendor/chosen_v1.2.0/chosen.min.css' %}">
    <link rel="stylesheet" href="{% sass_src 'css/report/report.scss' %}">
    {% leaflet_css plugins="forms" %}
{% endblock %}

{% block content %}
    <section>
        <div class="content-wrapper" id="new-report">
            <div class="content-heading">
                {% if editing %} {% trans 'Edit report' %} {% else %} {% trans 'New report' %} {% endif %}
            </div>

            <div class="row">
                <form action="" method="post" role="form" id="form-report" enctype="multipart/form-data">
                    <div class="col-lg-4">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <fieldset>
                                    {% csrf_token %}
                                    <div class="form-group {% if data_form.project.errors %}has-error{% endif %}">
                                        <label>{% trans 'Project' %}</label>
                                        {{ data_form.project }}
                                        {{ data_form.project.errors }}
                                    </div>

                                    <div class="form-group {% if data_form.theme.errors %}has-error{% endif %}">
                                        <label>{% trans 'Theme' %}</label>
                                        <select name="theme" required="" class="form-control" id="id_theme"></select>
                                        {{ data_form.theme.errors }}
                                    </div>

                                    <div class="form-group {% if data_form.mapper.errors %}has-error{% endif %}">
                                        <label>{% trans 'Mapper' %}</label>
                                        <select name="mapper" required="" class="form-control" id="id_mapper"></select>
                                        {{ data_form.mapper.errors }}
                                    </div>

                                    <div class="form-group {% if data_form.title.errors %}has-error{% endif %}">
                                        <label>{% trans 'Title' %}</label>
                                        {{ data_form.title }}
                                        {{ data_form.title.errors }}
                                    </div>

                                    <div class="form-group {% if data_form.description.errors %}has-error{% endif %}">
                                        <label>{% trans 'Description' %}</label>
                                        {{ data_form.description }}
                                        {{ data_form.description.errors }}
                                    </div>

                                    <div class="form-group {% if data_form.tags.errors %}has-error{% endif %}">
                                        <label>{% trans 'Tags' %}</label>
                                        {{ data_form.tags }}
                                        {{ data_form.tags.errors }}
                                    </div>

                                    <div class="form-group {% if data_form.files.errors %}has-error{% endif %}">
                                        <label>{% trans 'Add Photo/Video' %}</label>
                                        {{ data_form.files }}
                                        {{ data_form.files.errors }}
                                    </div>

                                    {% if files_list %}
                                        <label>{% trans 'Select to remove file' %}</label>
                                        {% for file in files_list %}
                                            <div class="row mt-10">
                                                <div class="col-md-1">
                                                    <div class="checkbox c-checkbox needsclick">
                                                        <label class="needsclick">
                                                            <input type="checkbox" name="remove_files[]"
                                                                   value="{{ file.id }}" class="needsclick"/>
                                                            <span class="fa fa-check"></span>
                                                        </label>
                                                    </div>
                                                </div>

                                                <div class="col-md-10">
                                                    {% if file.media_type == 'image' %}
                                                        <img src="{{ file.file.url }}" class="media-object thumb48"
                                                             alt="">
                                                    {% elif file.media_type == 'video' %}
                                                        <img src="{% static 'img/video.png' %}"
                                                             class="media-object thumb48" alt="">
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}

                                    <div class="form-group {% if data_form.link.errors %}has-error{% endif %}">
                                        <label>{% trans 'Links' %}</label>
                                        <div class="input-group">
                                            {{ data_form.link }}
                                            {{ data_form.link.errors }}

                                            <span class="input-group-btn">
                                                <button id="btnAddLink" type="button" class="btn btn-default">
                                                    <em class="fa fa-check"></em>
                                                </button>
                                            </span>
                                        </div>
                                    </div>

                                    <div id="links">
                                    </div>
                                </fieldset>
                                <a href="javascript:" onclick="submitForm()" class="pull-right btn btn-default create">
                                    {% if editing %} {% trans 'Save' %} {% else %} {% trans 'Create' %} {% endif %}
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div id="map">
                            {{ data_form.location }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>
{% endblock %}

{% block extrajs %}
    <script src="{% static 'vendor/chosen_v1.2.0/chosen.jquery.min.js' %}"></script>
    {% leaflet_js plugins="forms" %}

    <script type="text/javascript">
        let linksCount = 0;
        let mapObject = null;
        const themeMaps = [];
        let polygonMap = null;

        axios.defaults.headers.post = {'X-CSRFToken': '{{ csrf_token }}'};

        window.addEventListener('map:init', function(e) {
            mapObject = e.detail.map;
        });

        $('#id_tags').chosen();

        $('#btnAddLink').click(function(e) {
            const link = $('#id_link').val();
            if (link) {
                $('#links').append('<div class="form-group" id="link_' + linksCount + '"><div class="input-group"><input type="hidden" name="links[]" value="' + link + '" id="link_check_' + linksCount + '"><input type="text" value="' + link + '" disabled class="form-control"><span class="input-group-btn"><button type="button" onclick="removeLink(' + linksCount + ')" class="btn btn-default"><em class="fa fa-remove"></em></button></span></div></div>');
                linksCount += 1;
                $('#id_link').val('')
            }
        });

        {% if selected_links %}
            {% for link in selected_links %}
                $('#links').append('<div class="form-group" id="link_' + linksCount + '"><div class="input-group"><input type="hidden" name="links[]" value="{{ link }}" id="link_check_' + linksCount + '"><input type="text" value="{{ link }}" disabled class="form-control"><span class="input-group-btn"><button type="button" onclick="removeLink(' + linksCount + ')" class="btn btn-default"><em class="fa fa-remove"></em></button></span></div></div>');
                linksCount += 1;
            {% endfor %}
        {% endif %}

        function removeLink(item) {
            $('#link_' + item).empty();
        }

        $('#id_project').change(function (e) {
            e.preventDefault();
            loadThemes(e.target.value);
        });

        $('#id_theme').change(function (e) {
            e.preventDefault();
            loadMappers(e.target.value);
            loadThemeBounds(e.target.value);
        });

        function submitForm() {
            $('#form-report').submit();
        }

        function loadThemes(project, selected = null) {
            axios.get('{% url "voy-api:tags-list" %}?project=' + project).then((response) => {
                $('#id_tags').empty();
                $('#id_tags').trigger('chosen:updated');

                $('#id_theme').empty();
                $('#id_theme').trigger('chosen:updated');
                $('#id_theme').append('<option value="">{% trans 'Select one theme' %}</option>');

                $('#id_mapper').empty();
                $('#id_mapper').trigger('chosen:updated');

                response.data.map((item) => {
                    $('#id_tags').append('<option value="' + item.tag + '">' + item.tag + '</option>');
                    $('#id_tags').trigger('chosen:updated');
                });
            }).then(() => {
                axios.get('{% url "voy-api:themes-list" %}?project=' + project).then((response) => {
                    $('#id_theme').empty();
                    $('#id_theme').trigger('chosen:updated');
                    $('#id_theme').append('<option value="">{% trans 'Select one theme' %}</option>');
                    response.data.map((item) => {
                        $('#id_theme').append('<option value="' + item.id + '">' + item.name + '</option>');
                        $('#id_theme').trigger('chosen:updated');
                        themeMaps[item.id] = item.bounds;
                    });
                }).then(() => {
                    if (selected) {
                        $('#id_theme').val(selected);
                        loadMappers(selected, {{ data_form.mapper.value }});
                        setTimeout(() => {
                            loadThemeBounds(selected);
                        }, 2000);
                    }
                });
            }).then(() => {
                {% if selected_tags %}
                    const tags = [];
                    {% for tag in selected_tags %}
                        tags.push('{{ tag }}');
                    {% endfor %}
                    $('#id_tags').val(tags);
                    $('#id_tags').trigger('chosen:updated');
                {% endif %}
            });
        }

        function loadMappers(theme, selected = null) {
            axios.get('/api/mappers/?theme=' + theme).then((response) => {
                $('#id_mapper').empty();
                $('#id_mapper').trigger('chosen:updated');
                response.data.map((item) => {
                    $('#id_mapper').append('<option value="' + item.id + '">' + item.full_name + '</option>');
                    $('#id_mapper').trigger('chosen:updated');
                });
            }).then(() => {
                if (selected) {
                    $('#id_mapper').val(selected);
                }
            });
        }

        function loadThemeBounds(themeId) {
            if (themeId) {
                const bounds = themeMaps[themeId];

                if (polygonMap) {
                    mapObject.removeLayer(polygonMap);
                }
            
                polygonMap = new L.Polygon(bounds);
                polygonMap.setStyle({color: '#ff7800'});
                mapObject.addLayer(polygonMap);
                mapObject.fitBounds(polygonMap.getBounds());
            }
        }

        {% if data_form.project.value %}
            loadThemes($('#id_project option:selected').val(), {{ data_form.theme.value }});
        {% endif %}
    </script>
{% endblock %}

{% extends "voyadmin/base.html" %}

{% load static i18n sass_tags leaflet_tags %}

{% block extracss %}
    <link rel="stylesheet" href="{% sass_src 'css/report/report.scss' %}">
    {% leaflet_css %}
{% endblock %}

{% block content %}
    <section>
        <div class="content-wrapper" id="view-report">
            <div class="content-heading">
                {{ report.name }}
            </div>

            <ol class="breadcrumb">
                <li><a href="{% url 'voy-admin:projects:index' %}">{% trans 'My projects' %}</a></li>
                <li><a href="{% url 'voy-admin:themes:index' theme.project.pk %}">{{ theme.project.name }}</a></li>
                <li><a href="{% url 'voy-admin:reports:index' theme.pk %}">{{ theme.name }}</a></li>
                <li>{% trans 'Reports' %}</li>
                <li>{{ report.name }}</li>
            </ol>

            <div class="panel">
                <div class="panel-body">
                    <div class="pull-right buttons">
                        {% if report.status != 3 %}
                            <a href="{% url 'voy-admin:reports:edit' report.pk %}" class="btn btn-default edit">{% trans 'Edit' %}</a>
                        {% endif %}

                        {% if report.status == 1 %}
                            <a href="{% url 'voy-admin:reports:remove' report.pk %}" class="btn btn-danger delete">{% trans 'Delete' %}</a>
                        {% endif %}

                        {% if report.status == 2 %}
                            <a href="javascript:;" class="btn btn-danger reject" id="openModal">{% trans 'Not Approve' %}</a>
                            <a href="{% url 'voy-admin:reports:approve' report.pk %}" class="btn btn-success approve">{% trans 'Approve' %}</a>
                        {% endif %}
                    </div>

                    <h3 class="mt0">{{ report.name }}</h3>
                    {% trans 'By' %} {{ report.created_by.first_name }} {{ report.created_on|date:'d M Y' }} {{ report.comments_views.count }} {% trans 'comments' %}

                    <hr/>

                    <div class="row mb-lg">
                        <div class="col-lg-12 col-md-12">{{ report.description }}</div>
                    </div>

                    <div class="row mb-lg">
                        {% for file in report.files.all %}
                            <div class="col-md-3">
                                {% if file.media_type == 'image' %}
                                    <img src="{{ file.file.url }}" alt="" class="img-responsive">
                                {% elif file.media_type == 'video' %}
                                    <video width="335" height="180" controls>
                                        <source src="{{ file.file.url }}" type="video/mp4">
                                    </video>
                                {% endif %}
                            </div>
                        {% if forloop.counter|divisibleby:4 %}
                            </div>
                            <div class="row mb-lg">
                        {% endif %}
                        {% endfor %}
                    </div>

                    <div class="row mb-lg">
                        <div class="col-md-12">
                        {% for url in report.urls.all %}
                            <p>{{ url }}</p>
                        {% endfor %}
                        </div>
                    </div>

                    <div class="row mb-lg">
                        <div class="col-md-12">
                            {% leaflet_map "reportmap" %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 text-center">
                            <hr/>
                            <h2>{% trans 'Comments' %}</h2>
                        </div>
                    </div>

                    <div class="comments-list" id="comments">
                        <form action="{% url 'voy-admin:reports:comments-save' report.pk %}" method="post">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-12">
                                    <textarea name="comment" id="comments" cols="30" rows="5"></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 text-right">
                                    <button type="submit"
                                            class="btn btn-default btn-oval btn-save">{% trans 'Post' %}</button>
                                </div>
                            </div>
                        </form>

                        {% for comment in report.comments_views %}
                            <div class="mt-20">
                                <div class="row">
                                    <div class="col-md-1">
                                        <img src="{{ comment.created_by.get_avatar_display }}" alt="">
                                    </div>
                                    <div class="col-md-11">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong class="comment-author">{{ comment.created_by.username }}</strong>
                                                -
                                                <small>{{ comment.created_on|date:'d M Y - H:i' }}</small>
                                            </div>
                                            <div class="col-md-6 text-right">
                                                {% if comment.status == 2 %}
                                                    <a href="{% url 'voy-admin:reports:comments' comment.pk 1 %}"
                                                       class="btn btn-oval btn-default approve">{% trans 'Approve' %}</a>
                                                    <a href="{% url 'voy-admin:reports:comments' comment.pk 3 %}"
                                                       class="btn btn-oval btn-danger reject">{% trans 'Not Approve' %}</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-1">&nbsp;</div>
                                    <div class="col-md-11 comment-text">
                                        {{ comment.text }}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- modal -->
    <div id="modal">
        <div class="opacity"></div>
        <div class="content-modal">
            <form action="{% url 'voy-admin:reports:view' report.pk %}" id="formReject" method="post">
                <fieldset>
                    <input type="hidden" name="report" value="{{ report.pk }}"/>
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-12 text-center pt-10">
                            <h4>{% trans 'Feedback message' %}</h4>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 text-center textarea">
                            <textarea name="message" id="message" cols="40" rows="5"></textarea>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 buttons text-right">
                            <a href="javascript:;" class="btn btn-default cancel"
                               id="closeModal">{% trans 'Cancel' %}</a>
                            <a href="javascript:;" id="submitReject" class="btn btn-default send">{% trans 'Send' %}</a>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
{% endblock %}

{% block extrajs %}
    {% leaflet_js %}
    <script type="text/javascript">
        window.addEventListener('map:init', function(e) {
            const position = {{ report_location }};
            L.marker([position[1], position[0]]).addTo(e.detail.map);
        }, false);

        $('#openModal').click(function (e) {
            e.preventDefault();
            $('#modal').show();
        });

        $('#closeModal').click(function (e) {
            e.preventDefault();
            $('#modal').hide();
        });

        $('#submitReject').click(function () {
            if ($('#message').val()) {
                $('#formReject').submit();
            }
        })
    </script>
{% endblock %}
